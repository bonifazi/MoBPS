}
if(nodes[[to_node]]$'Breeding Type'=="Reproduction"){
nodes[[to_node]]$origin <- c(nodes[[to_node]]$origin,edges[[index]]$from)
nodes[[to_node]]$edge.nr <- c(nodes[[to_node]]$edge.nr,index)
nodes[[to_node]]$'Time Needed' <- c(nodes[[to_node]]$'Time Needed',edges[[index]]$'Time Needed')
}
if(nodes[[to_node]]$'Breeding Type'=="Recombination"){
nodes[[to_node]]$origin <- c(nodes[[to_node]]$origin,edges[[index]]$from)
nodes[[to_node]]$mutation <- edges[[index]]$'New Mutation Rate'
nodes[[to_node]]$remutation <- edges[[index]]$'New Remutation Rate'
nodes[[to_node]]$recom <- edges[[index]]$'Number of Rec per M'
nodes[[to_node]]$edge.nr <- c(nodes[[to_node]]$edge.nr,index)
nodes[[to_node]]$'Time Needed' <- c(nodes[[to_node]]$'Time Needed',edges[[index]]$'Time Needed')
}
if(nodes[[to_node]]$'Breeding Type'=="Reproduction_Selfing"){
nodes[[to_node]]$origin <- c(nodes[[to_node]]$origin,edges[[index]]$from)
nodes[[to_node]]$edge.nr <- c(nodes[[to_node]]$edge.nr,index)
nodes[[to_node]]$'Time Needed' <- c(nodes[[to_node]]$'Time Needed',edges[[index]]$'Time Needed')
}
if(nodes[[to_node]]$'Breeding Type'=="DH_Gene"){
nodes[[to_node]]$origin <- c(nodes[[to_node]]$origin,edges[[index]]$from)
nodes[[to_node]]$edge.nr <- c(nodes[[to_node]]$edge.nr,index)
nodes[[to_node]]$'Time Needed' <- c(nodes[[to_node]]$'Time Needed',edges[[index]]$'Time Needed')
}
if(nodes[[to_node]]$'Breeding Type'=="Cloning"){
nodes[[to_node]]$origin <- c(nodes[[to_node]]$origin,edges[[index]]$from)
nodes[[to_node]]$edge.nr <- c(nodes[[to_node]]$edge.nr,index)
nodes[[to_node]]$'Time Needed' <- c(nodes[[to_node]]$'Time Needed',edges[[index]]$'Time Needed')
}
if(nodes[[to_node]]$'Breeding Type'=="Combine"){
nodes[[to_node]]$origin <- c(nodes[[to_node]]$origin,edges[[index]]$from)
nodes[[to_node]]$edge.nr <- c(nodes[[to_node]]$edge.nr,index)
nodes[[to_node]]$'Time Needed' <- c(nodes[[to_node]]$'Time Needed',edges[[index]]$'Time Needed')
}
if(nodes[[to_node]]$'Breeding Type'=="Aging"){
nodes[[to_node]]$origin <- c(nodes[[to_node]]$origin,edges[[index]]$from)
nodes[[to_node]]$edge.nr <- c(nodes[[to_node]]$edge.nr,index)
nodes[[to_node]]$'Time Needed' <- c(nodes[[to_node]]$'Time Needed',edges[[index]]$'Time Needed')
}
}
phenotype_groups <- numeric(length(nodes))
for(index in 1:length(edges)){
phenotype_groups[which(ids==edges[[index]]$from)] <- 1
}
priority_breeding <- ids[(1-phenotype_groups)*1:length(ids)]
n_tester <- n_tester_generated <- numeric(length(nodes))
for(index in 1:length(edges)){
if(length(intersect(priority_breeding, edges[[index]]$to))){
n_tester[which(ids==edges[[index]]$from)] <- n_tester[which(ids==edges[[index]]$from)] +1
}
}
}
# Check for Split nodes
to_split <- NULL
split_info <- list()
split_part <- list()
for(index in 1:length(edges)){
if(edges[[index]]$'Breeding Type'=="Split"){
to_split <- unique(c(to_split, edges[[index]]$from))
split_nr <- which(to_split==edges[[index]]$from)
nodes_nr <- which(edges[[index]]$from==ids)
split_info[[split_nr]] <- 1:nodes[[nodes_nr]]$'Number of Individuals'
if(length(split_part)>= split_nr){
split_part[[split_nr]] <- c(split_part[[split_nr]], edges[[index]]$to)
} else{
split_part[[split_nr]] <- edges[[index]]$to
}
}
}
############## Founder Phenotypes ########################
for(index in 1:nrow(population$info$cohorts)){
breeding.diploid(population, heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
n.observation = pheno_index[which(pheno_index_name==nodes[[which(ids==population$info$cohorts[index,1])]]$'Phenotyping Class'),])
}
population$info$bv.calculated
population$info$bv.calculated
a <- breeding.diploid(population)
a$info$bv.calculated
############## Actual simulations ########################
{
generation <- 1
while(length(left)>0){
generation <- generation + 1
cat(paste0("Start simulation of generation:", generation,"\n"))
possible <- ids[left]
stock <- ids[-left]
for(index in 1:length(edges)){
there <- which(edges[[index]]$to==possible)
if(length(there)>0){
if(sum(edges[[index]]$from==stock)==0){
if(possible[there]=="B_pre_sel") cat(index)
possible <- possible[-there]
}
}
}
if(length(intersect(possible, priority_breeding))>0){
possible <- intersect(possible, priority_breeding)
} else{
stock <- ids[-unique(c(left, (n_tester>n_tester_generated)*(1:length(n_tester))))]
for(index in 1:length(edges)){
there <- which(edges[[index]]$to==possible)
if(length(there)>0){
if(sum(edges[[index]]$from==stock)==0){
possible <- possible[-there]
}
}
}
}
# Remove group for which not all testers are generated
if(length(possible)==0){
stop("invalite breeding program")
}
for(group in possible){
groupnr <- which(ids==group)
simulated <- c(simulated, groupnr)
sex <- as.numeric(nodes[[groupnr]]$'Sex'=="Female") + 1
breeding.size <- as.numeric(nodes[[groupnr]]$'Number of Individuals') * c(sex==1, sex==2)
involved_cohorts <- nodes[[groupnr]]$origin
cohort_data <- population$info$cohorts[involved_cohorts,,drop=FALSE]
sex_cohorts <- (as.numeric(cohort_data[,3])==0) +1
selection.size <- c(sum(as.numeric(cohort_data[,3])), sum(as.numeric(cohort_data[,4])))
cohorts.m <- involved_cohorts[sex_cohorts==1]
cohorts.f <- involved_cohorts[sex_cohorts==2]
involved_groups <- cbind(as.numeric(cohort_data[,2]), sex_cohorts)
# Derive time.point
time.point <- 0
origins <- nodes[[which(ids==group)]]$origin
time_needed <- as.numeric(nodes[[which(ids==group)]]$'Time Needed')
for(temp1 in 1:length(origins)){
time.point <- as.numeric(population$info$cohorts[population$info$cohorts[,1]==origins[temp1],8]) + time_needed[temp1]
}
time.point <- max(nodes[[which(ids==group)]]$earliest_time, time.point)
bve.database <- NULL
if(length(nodes[[groupnr]]$'Cohorts used in BVE') || nodes[[groupnr]]$`Breeding Type`=="Selection"){
if(length(nodes[[groupnr]]$'Cohorts used in BVE')==0){
bve.database <- involved_groups[,1:2, drop=FALSE]
} else if(nodes[[groupnr]]$'Cohorts used in BVE'=="Last 2 Generations"){
bve.database <- get.database(population, gen=max(1,generation-2):(generation-1))
} else if(nodes[[groupnr]]$'Cohorts used in BVE'=="All"){
bve.database <- get.database(population, gen=1:(generation-1))
} else if(nodes[[groupnr]]$'Cohorts used in BVE'=="Manuel") {
stop("Manual selection of cohorts for BVE not implemented")
} else if(nodes[[groupnr]]$'Cohorts used in BVE'=="Only this cohort"){
bve.database <- involved_groups[,1:2, drop=FALSE]
}
}
if(nodes[[groupnr]]$'Breeding Type'=="Selection"){
activemmreml <- FALSE
activbglr <- FALSE
if(nodes[[groupnr]]$'Selection Type'=="Phenotypic"){
bve <- FALSE
selection <- "function"
phenotype.bv <- TRUE
computeA <- "vanRaden"
} else if(nodes[[groupnr]]$'Selection Type'=="Random"){
bve <- FALSE
selection <- "random"
phenotype.bv <- FALSE
computeA <- "vanRaden"
} else if(nodes[[groupnr]]$'Selection Type'=="BVE"){
bve <- TRUE
selection <- "function"
phenotype.bv <- FALSE
if(nodes[[groupnr]]$'Relationship Matrix'=="Pedigree"){
cat("Dont use Pedigree currently\n")
} else{
computeA <- "vanRaden"
}
if(nodes[[groupnr]]$'BVE Method'=="REML-GBLUP"){
activemmreml <- TRUE
} else if(nodes[[groupnr]]$'BVE Method'=="RKHS") {
activbglr <- TRUE
}
}
if(length(involved_cohorts)>1){
stop("Only one cohort to select from allowed in selection - check for error")
} else{
add.observation <- pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),] -
pheno_index[which(pheno_index_name==nodes[[which(ids==involved_cohorts[1])]]$'Phenotyping Class'),]
add.observation[add.observation<0] <- 0
}
if(nodes[[groupnr]]$'Use Offspring for BVE'=="Yes"){
bve.childbase.parents <- involved_groups[,1:2,drop=FALSE]
if(length(pheno.sex)==1){
bve.childbase.children <- cbind((min(bve.childbase.parents[,1])+1): nrow(population$info$size),pheno.sex)
} else{
bve.childbase.children <- rbind(cbind((min(bve.childbase.parents[,1])+1): nrow(population$info$size),1),
cbind((min(bve.childbase.parents[,1])+1): nrow(population$info$size),2))
}
population <- breeding.diploid(population, breeding.size=breeding.size,
bve=bve, computation.A = computeA,
bve.childbase=TRUE,
bve.childbase.parents=bve.childbase.parents,
bve.childbase.children=bve.childbase.children,
BGLR.bve = activbglr,
emmreml.bve = activemmreml,
selection.size= breeding.size,
copy.individual = TRUE,
max.offspring = c(1,1),
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="addobs",
selection.m = selection,
selection.f = selection,
phenotype.bv = phenotype.bv,
add.gen = generation,
bve.database = bve.database,
selfing.mating=TRUE,
selfing.sex=(sex-1),
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
new.class = new_mig[sex],
multiple.bve.scale=TRUE,
multiple.bve.weights = selection_index[which(selection_index_name==nodes[[groupnr]]$'Selection Index'),],
n.observation = add.observation,
remove.effect.position = remove.effect.position,
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 1)
} else{
population <- breeding.diploid(population, breeding.size=breeding.size,
bve=bve, computation.A = computeA,
BGLR.bve = activbglr,
emmreml.bve = activemmreml,
selection.size= breeding.size,
copy.individual = TRUE,
max.offspring = c(1,1),
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="addobs",
selection.m = selection,
selection.f = selection,
phenotype.bv = phenotype.bv,
add.gen = generation,
bve.database = bve.database,
selfing.mating=TRUE,
selfing.sex=(sex-1),
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
new.class = new_mig[sex],
multiple.bve.scale=TRUE,
multiple.bve.weights = selection_index[which(selection_index_name==nodes[[groupnr]]$'Selection Index'),],
n.observation = add.observation,
remove.effect.position = remove.effect.position,
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 1)
}
} else if(nodes[[groupnr]]$'Breeding Type'=="Reproduction"){
population <- breeding.diploid(population, breeding.size=breeding.size,
selection.size= selection.size,
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="obs",
selection.m = "random",
add.gen = generation,
bve.database = bve.database,
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
n.observation = pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),],
new.class = new_mig[sex],
same.sex.activ = same.sex.activ,
same.sex.sex = same.sex.sex,
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 2)
} else if(nodes[[groupnr]]$'Breeding Type'=="Reproduction_Selfing"){
selfing.sex <- as.numeric(selection.size[2]>0)- 0.5 * as.numeric((selection.size[1]>0)*(selection.size[2]>0))
population <- breeding.diploid(population, breeding.size=breeding.size,
selection.size= selection.size,
selfing.mating = TRUE,
selfing.sex =  selfing.sex,
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="obs",
selection.m = "random",
add.gen = generation,
bve.database = bve.database,
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
n.observation = pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),],
new.class = new_mig[sex],
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 4)
} else if(nodes[[groupnr]]$'Breeding Type'=="DH_Gene"){
dh.sex <- as.numeric(selection.size[2]>0)- 0.5 * as.numeric((selection.size[1]>0)*(selection.size[2]>0))
population <- breeding.diploid(population, breeding.size=breeding.size,
selection.size= selection.size,
dh.mating = TRUE,
dh.sex =  dh.sex,
selfing.mating = TRUE,
selfing.sex = dh.sex,
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="obs",
selection.m = "random",
add.gen = generation,
bve.database = bve.database,
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
n.observation = pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),],
new.class = new_mig[sex],
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 5)
} else if(nodes[[groupnr]]$'Breeding Type'=="Recombination"){
population <- breeding.diploid(population, breeding.size=breeding.size,
mutation.rate = nodes[[groupnr]]$mutation,
remutation.rate = nodes[[groupnr]]$remutation,
recombination.rate = nodes[[groupnr]]$recom,
selection.size= selection.size,
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="obs",
selection.m = "random",
add.gen = generation,
bve.database = bve.database,
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
n.observation = pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),],
new.class = new_mig[sex],
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 3)
} else if(nodes[[groupnr]]$'Breeding Type'=="Cloning"){
selfing.sex <- as.numeric(selection.size[2]>0)- 0.5 * as.numeric((selection.size[1]>0)*(selection.size[2]>0))
if(length(involved_cohorts)>1){
stop("Only one cohort to select from allowed in selection - check for error")
} else{
add.observation <- pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),] -
pheno_index[which(pheno_index_name==nodes[[which(ids==involved_cohorts[1])]]$'Phenotyping Class'),]
add.observation[add.observation<0] <- 0
}
population <- breeding.diploid(population, breeding.size=breeding.size,
selection.size= selection.size,
copy.individual = TRUE,
selfing.mating = TRUE,
selfing.sex =  selfing.sex,
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="addobs",
selection.m = "random",
add.gen = generation,
bve.database = bve.database,
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
n.observation = pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),],
new.class = new_mig[sex],
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 6)
} else if(nodes[[groupnr]]$'Breeding Type'=="Aging"){
if(length(involved_cohorts)>1){
stop("Only one cohort to select from allowed in selection - check for error")
} else{
add.observation <- pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),] -
pheno_index[which(pheno_index_name==nodes[[which(ids==involved_cohorts[1])]]$'Phenotyping Class'),]
add.observation[add.observation<0] <- 0
}
selfing.sex <- (as.numeric(selection.size[2])>0)- 0.5 * as.numeric((selection.size[1]>0)*(selection.size[2]>0))
population <- breeding.diploid(population, breeding.size=breeding.size,
selection.size= selection.size,
copy.individual = TRUE,
selfing.mating = TRUE,
selfing.sex =  selfing.sex,
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="addobs",
selection.m = "random",
add.gen = generation,
bve.database = bve.database,
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
n.observation = add.observation,
new.class = new_mig[sex],
name.cohort = nodes[[groupnr]]$label,
max.offspring = 1,
time.point = time.point,
creating.type = 8)
} else if(nodes[[groupnr]]$'Breeding Type'=="Combine"){
selfing.sex <- (as.numeric(selection.size[2])>0)- 0.5 * as.numeric((selection.size[1]>0)*(selection.size[2]>0))
if(FALSE){
stop("Only one cohort to select from allowed in selection - check for error")
} else{
add.observation <- pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),] -
pheno_index[which(pheno_index_name==nodes[[which(ids==involved_cohorts[1])]]$'Phenotyping Class'),]
add.observation[add.observation<0] <- 0
cat(paste0("Newly phenotypes for combine note derived based on ", involved_cohorts[1]))
}
population <- breeding.diploid(population, breeding.size=breeding.size,
selection.size= breeding.size,
copy.individual = TRUE,
max.offspring = c(1,1),
new.bv.child="addobs",
selection.m = "random",
selfing.mating=TRUE,
selfing.sex=selfing.sex,
add.gen = generation,
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
n.observation = add.observation,
new.class = new_mig[sex],
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 7)
} else if(nodes[[groupnr]]$'Breeding Type'=="Split"){
split_nr <- which(nodes[[groupnr]]$origin==to_split)
selfing.sex <- (as.numeric(selection.size[2])>0)- 0.5 * as.numeric((selection.size[1]>0)*(selection.size[2]>0))
selfing.sex <- (as.numeric(selection.size[2])>0)- 0.5 * as.numeric((selection.size[1]>0)*(selection.size[2]>0))
if(length(involved_cohorts)>1){
stop("Only one cohort to select from allowed in selection - check for error")
} else{
add.observation <- pheno_index[which(pheno_index_name==nodes[[groupnr]]$'Phenotyping Class'),] -
pheno_index[which(pheno_index_name==nodes[[which(ids==involved_cohorts[1])]]$'Phenotyping Class'),]
add.observation[add.observation<0] <- 0
}
population <- breeding.diploid(population, breeding.size=breeding.size,
selection.size= breeding.size,
max.offspring = c(1,1),
copy.individual = TRUE,
selfing.mating = TRUE,
selfing.sex =  selfing.sex,
heritability = heritability,
sigma.e.database = cbind(1,(1:2)[population$info$size[1,]>0]),
new.bv.child="addobs",
selection.m = "random",
add.gen = generation,
bve.database = bve.database,
best1.from.cohort = cohorts.m,
best2.from.cohort = cohorts.f,
n.observation = add.observation,
reduced.selection.panel.m = split_info[[split_nr]],
reduced.selection.panel.f = split_info[[split_nr]],
new.class = new_mig[sex],
name.cohort = nodes[[groupnr]]$label,
time.point = time.point,
creating.type = 9,
store.breeding.totals = TRUE)
print(split_info)
split_info[[split_nr]] <- sort(setdiff(split_info[[split_nr]], split_info[[split_nr]][population$info$breeding.totals[[length(population$info$breeding.totals)]][[7]][[selfing.sex+1]]]))
print(split_info)
}
position[groupnr,] <- c(generation, sex, new_mig[sex], sum(breeding.size))
new_mig[sex] <- new_mig[sex] + 1
if(phenotype_groups[groupnr]==0){
tested <- which(duplicated(c(nodes[[groupnr]]$origin, ids))[-(1:length(nodes[[groupnr]]$origin))])
n_tester_generated[tested] <- n_tester_generated[tested] + 1
}
}
cat("Generated groups:")
cat(possible)
left <- (1:groups)[-simulated]
}
}
warnings()
population$info$size
population$info$snp
haplo <- get.haplo(population, gen=1)
chr.nr <- sum(population$info$snp)
start <- 1
for(index in 1:length(population$info$snp)){
if(population$info$snp[index]>0){
chr.nr[start:(start+population$info$snp[index]-1)] <- index
start <- start + population$info$snp[index]
}
}
map <- data.frame(chr=chr.nr, pos=population$info$bp )
map
population$info$bp
map <- cbind(chr.nr, population$info$snp.name, 0 population$info$bp)
chr.nr
population$info$snp.name
map <- cbind(chr.nr, population$info$snp.name, 0 ,population$info$bp)
map
rownames(haplo)
ped <- matrix("A", nrow=ncol(haplo)/2, ncol=nrow(haplo)*2)
ped
nrow(haplo)
dim(haplo)
haplo1 <- t(haplo[(1:(nrow(haplo)/2))*2,])
dim(haplo1)
haplo1 <- t(haplo[,(1:(ncol(haplo)/2))*2])
dim(haplo1)
haplo1 <- t(haplo[,(1:(ncol(haplo)/2))*2-1])
haplo2 <- t(haplo[,(1:(ncol(haplo)/2))*2])
dim(haplo1)
rep(1:ncol(haplo1), each=2)
c(0,ncol(haplo1))+ rep(1:ncol(haplo1), each=2)
ped <- ped[,c(0,ncol(haplo1))+ rep(1:ncol(haplo1), each=2)]
dim(ped)
pedfile <- cbind(1, 1:nrow(ped),0,0,0,0,ped)
dim(pedfile)
library(MoBPS)
population$info$snp.base
ped
ped <- ped[,c(0,ncol(haplo1))+ rep(1:ncol(haplo1), each=2)]
ped[ped==0]
ped
haplo1 <- t(haplo[,(1:(ncol(haplo)/2))*2-1])
haplo2 <- t(haplo[,(1:(ncol(haplo)/2))*2])
ped <- cbind(haplo1, haplo2)
ped
ped <- ped[,c(0,ncol(haplo1))+ rep(1:ncol(haplo1), each=2)]
ped
ped[ped==0]
population$info$snp.base
population$info$snp.base[1,][ped==0]
ped==0
population$info$bp
population$info$snp.name
